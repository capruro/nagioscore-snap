name: nagios
version: 4.4.6
summary: Nagios is a host/service/network monitoring program.
description: |
  Nagios is a host/service/network monitoring program written in C and released under the GNU General Public License, version 2. 
  CGI programs are included to allow you to view the current status, history, etc via a web interface if you so desire.
  Visit the Nagios homepage at https://www.nagios.org for documentation, new releases, bug reports, information on discussion forums, and more.

confinement: devmode
grade: stable
base: core20

apps:
  nagios-core:
    command: nagios
    daemon: simple
    restart-condition: always
    plugs: [network, network-bind]
  
  verifyconfig:
    command: nagios -v $SNAP_COMMON/usr/local/nagios/etc/nagios.cfg


parts:
  nagios-core:
    source: https://github.com/NagiosEnterprises/nagioscore/releases/download/nagios-4.4.6/nagios-4.4.6.tar.gz
    plugin: autotools
    autotools-configure-parameters:
      - --with-httpd-conf=/etc/apache2/sites-enabled
    override-build: |
        snapcraftctl build
        make install-groups-users
        usermod -a -G nagios www-data
        make install-daemoninit
        make install-commandmode
        make install-config
        make install-webconf
        a2enmod cgi
        a2enmod rewrite
        htpasswd -bc /usr/local/nagios/etc/htpasswd.users nagiosadmin nagiosadmin
        systemctl restart apache2.service
    build-packages: [autoconf, gcc, libc6, make, wget, unzip, apache2, php, libapache2-mod-php7.4, libgd-dev]
    stage-packages: [wget, unzip, apache2, php, libapache2-mod-php7.4, libgd-dev]
    
  nagios-plugins:
    after:
      - nagios-core
    source: https://nagios-plugins.org/download/nagios-plugins-2.3.3.tar.gz
    plugin: autotools
    override-build: |
      ./tools/setup
      snapcraftctl build
    build-packages:
      - autoconf
      - gcc
      - libc6
      - libmcrypt-dev
      - make
      - libssl-dev
      - wget
      - bc
      - gawk
      - dc
      - build-essential
      - snmp
      - libnet-snmp-perl
      - gettext
      - libpqxx3-dev
      - libdbi-dev
      - libldap2-dev
      - libfreeradius-client-dev
      - libmysqlclient-dev
      - dnsutils
      - smbclient
      - qstat
      - fping
      - qmail-tools
      
    stage-packages:
      - libc6
      - libmcrypt-dev
      - libssl-dev
      - wget
      - bc
      - gawk
      - dc
      - snmp
      - libnet-snmp-perl
      - gettext
      - libpqxx3-dev
      - libdbi-dev
      - libldap2-dev
      - libfreeradius-client-dev
      - libmysqlclient-dev
      - dnsutils
      - smbclient
      - qstat
      - fping
      - qmail-tools
      

layout:
  usr/local/nagios:
    bind: $SNAP_COMMON/usr/local/nagios
